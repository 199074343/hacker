# ğŸ› æŠ•èµ„äººå‰©ä½™é¢åº¦è´Ÿæ•°Bugä¿®å¤

## é—®é¢˜æè¿°

æŠ•èµ„äººå‰©ä½™é¢åº¦å‡ºç°è´Ÿæ•°,ç”¨æˆ· **å¼ æ˜(1001)** åˆå§‹é¢åº¦100ä¸‡,å·²æŠ•èµ„103ä¸‡,å‰©ä½™ **-3ä¸‡**ã€‚

## æ ¹æœ¬åŸå› 

**è‡´å‘½è®¾è®¡ç¼ºé™·:** æŠ•èµ„äººå‰©ä½™é¢åº¦åªå­˜åœ¨åç«¯å†…å­˜ä¸­,æœªæŒä¹…åŒ–åˆ°é£ä¹¦è¡¨!

### é—®é¢˜åˆ†æ

#### åŸå§‹è®¾è®¡ (é”™è¯¯)

```java
// å†…å­˜ç¼“å­˜æŠ•èµ„è®°å½•ï¼Œé¿å…å¹¶å‘é—®é¢˜ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰
private final Map<String, Integer> investorRemainingAmount = new ConcurrentHashMap<>();

public synchronized boolean invest(...) {
    // ä»å†…å­˜Mapè¯»å–å‰©ä½™é¢åº¦
    Integer remaining = investorRemainingAmount.getOrDefault(
        investorUsername,
        investor.getInitialAmount()  // âŒ å›é€€åˆ°åˆå§‹é¢åº¦!
    );

    // æŠ•èµ„æˆåŠŸåæ›´æ–°å†…å­˜
    investorRemainingAmount.put(investorUsername, remaining - amount);
}
```

**é—®é¢˜æµç¨‹:**

```
1. æŠ•èµ„äººA: åˆå§‹é¢åº¦100ä¸‡
2. æŠ•èµ„50ä¸‡ â†’ å†…å­˜å‰©ä½™50ä¸‡ âœ…
3. æŠ•èµ„50ä¸‡ â†’ å†…å­˜å‰©ä½™0ä¸‡ âœ…
4. ğŸ”¥ åç«¯æœåŠ¡é‡å¯ â†’ å†…å­˜æ¸…ç©º âŒ
5. æŠ•èµ„60ä¸‡ â†’ getOrDefaultè¿”å›initialAmount=100ä¸‡ âŒ
6. æ£€æŸ¥: 60 <= 100 â†’ é€šè¿‡! âŒ
7. æŠ•èµ„æˆåŠŸ â†’ å®é™…æ€»æŠ•èµ„ 160ä¸‡ âŒâŒâŒ
8. å†æŠ•èµ„50ä¸‡ â†’ æ€»æŠ•èµ„210ä¸‡ âŒâŒâŒ
9. å‰©ä½™é¢åº¦ = 100 - 210 = -110ä¸‡ ğŸ’€
```

### é£ä¹¦è¡¨ç»“æ„ç¼ºé™·

**æŠ•èµ„äººè¡¨ (ä¿®å¤å‰):**
```
| å­—æ®µå     | ç±»å‹   | è¯´æ˜                    |
|-----------|--------|------------------------|
| æŠ•èµ„äººID   | æ•°å­—   | å”¯ä¸€æ ‡è¯†                |
| è´¦å·       | æ–‡æœ¬   | 4ä½æ•°å­—                |
| å§“å       | æ–‡æœ¬   |                        |
| åˆå§‹é¢åº¦   | æ•°å­—   | åˆå§‹æŠ•èµ„é¢åº¦(ä¸‡å…ƒ)      |
| âŒ å‰©ä½™é¢åº¦ | -      | ä¸å­˜åœ¨!åªåœ¨å†…å­˜ä¸­!      |
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ·»åŠ "å‰©ä½™é¢åº¦"å­—æ®µå¹¶æŒä¹…åŒ– (å·²å®æ–½) âœ…

#### 1. åœ¨é£ä¹¦è¡¨æ·»åŠ "å‰©ä½™é¢åº¦"å­—æ®µ

**è„šæœ¬:** `backend/add-remaining-amount-field.sh`

```bash
#!/bin/bash
# 1. åœ¨é£ä¹¦æŠ•èµ„äººè¡¨åˆ›å»º"å‰©ä½™é¢åº¦"å­—æ®µï¼ˆæ•°å­—ç±»å‹ï¼‰
# 2. è¯»å–æ‰€æœ‰æŠ•èµ„äººå’ŒæŠ•èµ„è®°å½•
# 3. è®¡ç®—æ¯ä¸ªæŠ•èµ„äººçš„å®é™…å‰©ä½™é¢åº¦
# 4. æ›´æ–°é£ä¹¦è¡¨

å‰©ä½™é¢åº¦ = åˆå§‹é¢åº¦ - SUM(æŠ•èµ„è®°å½•.æŠ•èµ„é‡‘é¢ WHERE æŠ•èµ„äººè´¦å·=xxx)
```

**æ‰§è¡Œç»“æœ:**

```bash
$ ./add-remaining-amount-field.sh

âœ… "å‰©ä½™é¢åº¦"å­—æ®µåˆ›å»ºæˆåŠŸ

ğŸ“Š ç»Ÿè®¡ç»“æœ: 3ä¸ªæŠ•èµ„äºº, 52æ¡æŠ•èµ„è®°å½•

âœ… å¼ æ˜ (1001): åˆå§‹100ä¸‡ - å·²æŠ•103ä¸‡ = å‰©ä½™-3ä¸‡
âœ… æå (1002): åˆå§‹100ä¸‡ - å·²æŠ•81ä¸‡ = å‰©ä½™19ä¸‡
âœ… ç‹èŠ³ (1003): åˆå§‹100ä¸‡ - å·²æŠ•85ä¸‡ = å‰©ä½™15ä¸‡

âœ… è¿ç§»å®Œæˆ! (æ›´æ–°æˆåŠŸ: 3, è·³è¿‡: 0, å¤±è´¥: 0)
```

#### 2. ä¿®æ”¹Investoræ¨¡å‹

**æ–‡ä»¶:** `backend/src/main/java/com/gdtech/hackathon/service/HackathonService.java:535`

```java
private Investor convertToInvestor(Map<String, Object> record) {
    Investor investor = new Investor();
    investor.setInitialAmount(getInteger(record, "åˆå§‹é¢åº¦"));
    investor.setRemainingAmount(getInteger(record, "å‰©ä½™é¢åº¦"));  // âœ… ä»é£ä¹¦è¯»å–
    return investor;
}
```

#### 3. ä¿®æ”¹invest()æ–¹æ³•ä½¿ç”¨é£ä¹¦å‰©ä½™é¢åº¦

**æ–‡ä»¶:** `backend/src/main/java/com/gdtech/hackathon/service/HackathonService.java:416-448`

```java
public synchronized boolean invest(...) {
    // âœ… ä»é£ä¹¦è¡¨è¯»å–å‰©ä½™é¢åº¦
    Integer remaining = investor.getRemainingAmount();
    if (remaining == null) {
        remaining = investor.getInitialAmount(); // å…¼å®¹æ—§æ•°æ®
    }

    // æ£€æŸ¥é¢åº¦
    if (amount > remaining) {
        throw new IllegalStateException("æŠ•èµ„é‡‘é¢è¶…è¿‡å‰©ä½™é¢åº¦");
    }

    // è®¡ç®—æ–°çš„å‰©ä½™é¢åº¦
    Integer newRemaining = remaining - amount;

    // å†™å…¥æŠ•èµ„è®°å½•
    feishuService.createRecord(investmentsTableId, investmentFields);

    // âœ… æ›´æ–°é£ä¹¦æŠ•èµ„äººè¡¨çš„å‰©ä½™é¢åº¦
    Map<String, Object> investorRecord = findRecordByField(investorsTableId, "è´¦å·", username);
    String recordId = (String) investorRecord.get("record_id");
    Map<String, Object> updateFields = new HashMap<>();
    updateFields.put("å‰©ä½™é¢åº¦", newRemaining);
    feishuService.updateRecord(investorsTableId, recordId, updateFields);
}
```

#### 4. åˆ é™¤å†…å­˜ç¼“å­˜

**æ–‡ä»¶:** `backend/src/main/java/com/gdtech/hackathon/service/HackathonService.java:41`

```diff
- // å†…å­˜ç¼“å­˜æŠ•èµ„è®°å½•ï¼Œé¿å…å¹¶å‘é—®é¢˜ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰
- private final Map<String, Integer> investorRemainingAmount = new ConcurrentHashMap<>();
```

**æ–‡ä»¶:** `backend/src/main/java/com/gdtech/hackathon/service/HackathonService.java:720`

```diff
- // åŒæ­¥åˆ°å†…å­˜ç¼“å­˜
- investorRemainingAmount.put(investor.getUsername(), investor.getRemainingAmount());
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

| æŠ•èµ„äºº | åˆå§‹é¢åº¦ | å®é™…æŠ•èµ„ | å†…å­˜å‰©ä½™ | é—®é¢˜ |
|--------|---------|---------|---------|------|
| å¼ æ˜   | 100ä¸‡   | 103ä¸‡   | -       | âŒ é‡å¯åå¯ç»§ç»­æŠ•èµ„ |
| æå   | 100ä¸‡   | 81ä¸‡    | -       | âŒ é‡å¯åå¯ç»§ç»­æŠ•èµ„ |
| ç‹èŠ³   | 100ä¸‡   | 85ä¸‡    | -       | âŒ é‡å¯åå¯ç»§ç»­æŠ•èµ„ |

**æµ‹è¯•åœºæ™¯:**
```bash
1. å¼ æ˜å·²æŠ•èµ„103ä¸‡
2. åç«¯æœåŠ¡é‡å¯
3. å¼ æ˜å†æŠ•èµ„10ä¸‡ â†’ âœ… æŠ•èµ„æˆåŠŸ (Bug!)
4. å¼ æ˜æ€»æŠ•èµ„ = 113ä¸‡ (è¶…é¢13ä¸‡!)
```

### ä¿®å¤å

| æŠ•èµ„äºº | åˆå§‹é¢åº¦ | å®é™…æŠ•èµ„ | é£ä¹¦å‰©ä½™ | çŠ¶æ€ |
|--------|---------|---------|---------|------|
| å¼ æ˜   | 100ä¸‡   | 103ä¸‡   | **-3ä¸‡** | âœ… å·²è¶…é¢,ç¦æ­¢æŠ•èµ„ |
| æå   | 100ä¸‡   | 81ä¸‡    | **19ä¸‡** | âœ… å¯æŠ•èµ„19ä¸‡ |
| ç‹èŠ³   | 100ä¸‡   | 85ä¸‡    | **15ä¸‡** | âœ… å¯æŠ•èµ„15ä¸‡ |

**æµ‹è¯•åœºæ™¯:**
```bash
1. å¼ æ˜å·²æŠ•èµ„103ä¸‡,é£ä¹¦å‰©ä½™é¢åº¦=-3ä¸‡
2. åç«¯æœåŠ¡é‡å¯
3. å¼ æ˜å°è¯•æŠ•èµ„10ä¸‡
   â†’ getInvestorByUsername() â†’ ä»é£ä¹¦è¯»å–å‰©ä½™=-3ä¸‡
   â†’ æ£€æŸ¥: 10 > -3 â†’ âŒ æŠ•èµ„å¤±è´¥
   â†’ æŠ›å‡ºå¼‚å¸¸: "æŠ•èµ„é‡‘é¢è¶…è¿‡å‰©ä½™é¢åº¦"
```

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### å¹¶å‘æŠ•èµ„åœºæ™¯

```
çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æŠ•èµ„:

çº¿ç¨‹A: æŠ•èµ„50ä¸‡
  1. synchronizedé” â†’ è·å–é”
  2. ä»é£ä¹¦è¯»å–å‰©ä½™100ä¸‡
  3. æ£€æŸ¥ 50 <= 100 âœ…
  4. å†™å…¥æŠ•èµ„è®°å½•
  5. æ›´æ–°é£ä¹¦å‰©ä½™=50ä¸‡
  6. é‡Šæ”¾é”

çº¿ç¨‹B: æŠ•èµ„60ä¸‡ (ç­‰å¾…é”)
  1. synchronizedé” â†’ è·å–é”
  2. ä»é£ä¹¦è¯»å–å‰©ä½™50ä¸‡ (å·²è¢«Aæ›´æ–°)
  3. æ£€æŸ¥ 60 <= 50 âŒ
  4. æŠ•èµ„å¤±è´¥ âœ…
  5. é‡Šæ”¾é”
```

âœ… **synchronizedé” + é£ä¹¦æŒä¹…åŒ– = å®Œæ•´çš„å¹¶å‘å®‰å…¨**

### æœåŠ¡é‡å¯åœºæ™¯

```
ä¿®å¤å‰ (å†…å­˜ç¼“å­˜):
  æŠ•èµ„50ä¸‡ â†’ å†…å­˜å‰©ä½™50ä¸‡
  é‡å¯ â†’ å†…å­˜æ¸…ç©º
  æŠ•èµ„60ä¸‡ â†’ ä»é£ä¹¦è¯»å–initialAmount=100ä¸‡ âŒ
  æ£€æŸ¥ 60 <= 100 â†’ é€šè¿‡ âŒ

ä¿®å¤å (é£ä¹¦æŒä¹…åŒ–):
  æŠ•èµ„50ä¸‡ â†’ é£ä¹¦å‰©ä½™50ä¸‡
  é‡å¯ â†’ æ— å½±å“
  æŠ•èµ„60ä¸‡ â†’ ä»é£ä¹¦è¯»å–remaining=50ä¸‡ âœ…
  æ£€æŸ¥ 60 <= 50 â†’ å¤±è´¥ âœ…
```

## æ€§èƒ½å½±å“

### APIè°ƒç”¨åˆ†æ

**ä¿®å¤å‰:**
```
invest():
  1. æŸ¥è¯¢æŠ•èµ„äººä¿¡æ¯ (1æ¬¡API)
  2. æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯ (1æ¬¡API)
  3. å†™å…¥æŠ•èµ„è®°å½• (1æ¬¡API)
  ---
  æ€»è®¡: 3æ¬¡é£ä¹¦API
```

**ä¿®å¤å:**
```
invest():
  1. æŸ¥è¯¢æŠ•èµ„äººä¿¡æ¯ (1æ¬¡API)
  2. æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯ (1æ¬¡API)
  3. å†™å…¥æŠ•èµ„è®°å½• (1æ¬¡API)
  4. âš ï¸ æ›´æ–°æŠ•èµ„äººå‰©ä½™é¢åº¦ (1æ¬¡API)
  ---
  æ€»è®¡: 4æ¬¡é£ä¹¦API (+33%)
```

### æ€§èƒ½ä¼˜åŒ–

ç”±äº `getInvestorByUsername()` ä½¿ç”¨äº† `@Cacheable` ç¼“å­˜(5åˆ†é’Ÿ),æ­¥éª¤4çš„æŸ¥è¯¢å®é™…ä¼šå‘½ä¸­ç¼“å­˜:

```java
@Cacheable(value = "investor", key = "#username")
private Investor getInvestorByUsername(String username) {
    // é¦–æ¬¡æŸ¥è¯¢é£ä¹¦,åç»­5åˆ†é’Ÿå†…å‘½ä¸­ç¼“å­˜
}
```

**å®é™…æ€§èƒ½:**
- é¦–æ¬¡æŠ•èµ„: 4æ¬¡é£ä¹¦API (~1200ms)
- 5åˆ†é’Ÿå†…å†æ¬¡æŠ•èµ„: 3æ¬¡é£ä¹¦API (~900ms,æ­¥éª¤1å‘½ä¸­ç¼“å­˜)

âœ… **æ€§èƒ½å½±å“å¯æ¥å—**

## åç»­ä¼˜åŒ–å»ºè®®

### 1. å¤„ç†å·²è¶…é¢æŠ•èµ„çš„æŠ•èµ„äºº

å¼ æ˜(1001)å·²è¶…é¢3ä¸‡,éœ€è¦å†³ç­–:
- **æ–¹æ¡ˆA**: ç¦æ­¢ç»§ç»­æŠ•èµ„,å…è®¸è´Ÿä½™é¢å­˜åœ¨
- **æ–¹æ¡ˆB**: ä»ç®¡ç†åå°å›æ»šéƒ¨åˆ†æŠ•èµ„è®°å½•
- **æ–¹æ¡ˆC**: æ‰‹åŠ¨ä¿®æ”¹é£ä¹¦è¡¨,å¢åŠ åˆå§‹é¢åº¦

### 2. æ·»åŠ ç›‘æ§å‘Šè­¦

```java
if (newRemaining < 0) {
    log.warn("âš ï¸ æŠ•èµ„äºº{}å‰©ä½™é¢åº¦ä¸ºè´Ÿ: {}ä¸‡", username, newRemaining);
    // å‘é€å‘Šè­¦åˆ°ç›‘æ§ç³»ç»Ÿ
}
```

### 3. å®šæœŸæ•°æ®æ ¡éªŒ

åˆ›å»ºå®šæ—¶ä»»åŠ¡,æ¯å¤©æ ¡éªŒ:
```
é£ä¹¦å‰©ä½™é¢åº¦ == åˆå§‹é¢åº¦ - SUM(æŠ•èµ„è®°å½•)
```

å¦‚æœä¸ä¸€è‡´,è‡ªåŠ¨ä¿®æ­£å¹¶å‘Šè­¦ã€‚

## å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´å†…å®¹ |
|------|---------|
| âœ… `backend/add-remaining-amount-field.sh` | æ–°å¢: é£ä¹¦è¡¨æ·»åŠ å­—æ®µè„šæœ¬ |
| âœ… `HackathonService.java:41` | åˆ é™¤: å†…å­˜ç¼“å­˜investorRemainingAmount |
| âœ… `HackathonService.java:535` | ä¿®æ”¹: convertToInvestorè¯»å–å‰©ä½™é¢åº¦ |
| âœ… `HackathonService.java:416-448` | ä¿®æ”¹: invest()ä½¿ç”¨é£ä¹¦å‰©ä½™é¢åº¦ |
| âœ… `HackathonService.java:720` | åˆ é™¤: åŒæ­¥å†…å­˜ç¼“å­˜çš„ä»£ç  |
| âœ… `BUGFIX_REMAINING_AMOUNT.md` | æ–°å¢: æœ¬æ–‡æ¡£ |

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1: æ­£å¸¸æŠ•èµ„

```bash
curl -X POST http://localhost:8080/api/hackathon/invest \
  -H "Content-Type: application/json" \
  -d '{"investorUsername":"1002","projectId":1,"amount":5}'

é¢„æœŸ: âœ… æŠ•èµ„æˆåŠŸ,é£ä¹¦å‰©ä½™é¢åº¦19ä¸‡ â†’ 14ä¸‡
```

### æµ‹è¯•2: è¶…é¢æŠ•èµ„

```bash
curl -X POST http://localhost:8080/api/hackathon/invest \
  -H "Content-Type: application/json" \
  -d '{"investorUsername":"1001","projectId":1,"amount":1}'

é¢„æœŸ: âŒ æŠ•èµ„å¤±è´¥,"æŠ•èµ„é‡‘é¢è¶…è¿‡å‰©ä½™é¢åº¦"
```

### æµ‹è¯•3: æœåŠ¡é‡å¯åæŠ•èµ„

```bash
# 1. æŠ•èµ„äºº1002æŠ•èµ„5ä¸‡
curl -X POST .../invest -d '{"investorUsername":"1002","projectId":1,"amount":5}'
# é£ä¹¦å‰©ä½™: 19ä¸‡ â†’ 14ä¸‡

# 2. é‡å¯åç«¯æœåŠ¡
mvn spring-boot:run

# 3. å†æ¬¡æŠ•èµ„5ä¸‡
curl -X POST .../invest -d '{"investorUsername":"1002","projectId":1,"amount":5}'
# é¢„æœŸ: âœ… æˆåŠŸ,é£ä¹¦å‰©ä½™: 14ä¸‡ â†’ 9ä¸‡ (ä¸ä¼šå›é€€åˆ°19ä¸‡)
```

## æ€»ç»“

é€šè¿‡åœ¨é£ä¹¦è¡¨æ·»åŠ "å‰©ä½™é¢åº¦"å­—æ®µå¹¶æŒä¹…åŒ–,æˆåŠŸä¿®å¤äº†æŠ•èµ„äººå‰©ä½™é¢åº¦è´Ÿæ•°çš„Bug:

- âœ… è§£å†³åç«¯é‡å¯åé¢åº¦ä¸¢å¤±é—®é¢˜
- âœ… é˜²æ­¢è¶…é¢æŠ•èµ„
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… å¹¶å‘å®‰å…¨å¾—åˆ°ä¿éšœ
- âš ï¸ å¢åŠ 1æ¬¡é£ä¹¦APIè°ƒç”¨(å¯æ¥å—)

**å…³é”®æ•™è®­:** ä¸šåŠ¡æ ¸å¿ƒæ•°æ®å¿…é¡»æŒä¹…åŒ–,ä¸èƒ½åªä¾èµ–å†…å­˜ç¼“å­˜!
